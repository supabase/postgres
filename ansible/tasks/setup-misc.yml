# WAL-G
- name: Install daemontools
  become: yes
  apt:
    pkg:
      - daemontools

- name: wal-g system dependencies
  apt:
    pkg:
      - liblzo2-dev
      - cmake
      - build-essential

# find platform architecture
- name: finding platform architecture
  shell: if [ $(uname -m) = "aarch64" ]; then echo "arm64";  else echo "amd64"; fi
  register: platform_output
- set_fact:
    platform: "{{ platform_output.stdout }}"

# install go dependency for WAL-G
- name: wal-g go dependency
  get_url:
    url: "https://golang.org/dl/go{{ golang_version }}.linux-{{ platform }}.tar.gz"
    dest: /tmp
- name: unpack go archive
  unarchive:
    remote_src: yes
    src: "/tmp/go{{ golang_version }}.linux-{{ platform }}.tar.gz"
    dest: /usr/local

# Download WAL-G
- name: download wal-g
  shell:
    cmd: go get github.com/wal-g/wal-g;
  environment:
    PATH: "{{ ansible_env.PATH }}:/usr/local/go/bin"
  ignore_errors: yes
  # ignore error https://github.com/wal-g/wal-g/issues/343#issuecomment-514544288

# Install WAL-G
- name: install wal-g
  become: yes
  shell:
    cmd: make install && make deps && make pg_install
    chdir: "{{ ansible_env.HOME }}/go/src/github.com/wal-g/wal-g"
  environment:
    GOBIN: "/usr/local/bin"
    PATH: "{{ ansible_env.PATH }}:/usr/local/go/bin"

# Install PgBouncer
- name: install PgBouncer
  become: yes
  apt:
    pkg:
      - pgbouncer

- name: create directories
  file:
    state: directory
    path: "{{ item }}"
    owner: root
    mode: '0700'
  become: yes
  with_items:
    - /opt/postgres_exporter
    - /etc/systemd/system/exporter.service.d

- name: download postgres exporter
  get_url:
    url: "https://github.com/prometheus-community/postgres_exporter/releases/download/v{{ postgres_exporter_release }}/postgres_exporter-{{ postgres_exporter_release }}.linux-{{ platform }}.tar.gz"
    dest: /tmp/postgres_exporter.tar.gz

- name: expand postgres exporter
  unarchive:
    remote_src: yes
    src: /tmp/postgres_exporter.tar.gz
    dest: /opt/postgres_exporter
    extra_opts: [--strip-components=1]
  become: yes

- name: exporter: create a service
  template:
    src: files/exporter.service.j2
    dest: /etc/systemd/system/postgres-exporter.service

- name: exporter: copy over queries
  template:
    src: files/queries.yml
    dest: /opt/postgres_exporter/queries.yml

- name: exporter: enable service
  systemd:
    enabled: yes
    name: postgres_exporter
    daemon_reload: yes
