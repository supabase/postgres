- hosts: all
  become: yes

  pre_tasks:
    - import_tasks: tasks/setup-system.yml

  vars_files:
    - ./vars.yml

  vars:
    sql_files:
      - { source: "stat_extension.sql", dest: "01-extension.sql" }

  environment:
    PATH: /usr/lib/postgresql/bin:{{ ansible_env.PATH }}

  tasks:
    - set_fact:
        supabase_internal: true
      tags:
        - install-supabase-internal

    - set_fact:
        parallel_jobs: 16

    - name: Install Postgres from source
      import_tasks: tasks/setup-postgres.yml

    - name: Install Postgres extensions
      import_tasks: tasks/setup-extensions.yml

    - name: Install PgBouncer
      import_tasks: tasks/setup-pgbouncer.yml
      tags:
        - install-pgbouncer

    - name: Install Supabase specific content
      import_tasks: tasks/setup-supabase-internal.yml
      tags:
        - install-supabase-internal

    - name: Start Postgres Database
      systemd:
        name: postgresql
        state: started

    - name: Transfer init SQL files
      copy:
        src: files/{{ item.source }}
        dest: /tmp/{{ item.dest }}
      loop: "{{ sql_files }}"

    - name: Execute init SQL files
      become: yes
      become_user: postgres
      shell:
        cmd: /usr/lib/postgresql/bin/psql -f /tmp/{{ item.dest }}
      loop: "{{ sql_files }}"

    - name: Delete SQL scripts
      file:
        path: /tmp/{{ item.dest }}
        state: absent
      loop: "{{ sql_files }}"

    - name: Install WAL-G
      import_tasks: tasks/setup-wal-g.yml

    - name: Install PostgREST
      import_tasks: tasks/setup-postgrest.yml
      tags:
        - install-postgrest

    - name: Clean out build dependencies
      import_tasks: tasks/clean-build-dependencies.yml

    - name: Adjust APT update intervals
      copy:
        src: files/apt_periodic
        dest: /etc/apt/apt.conf.d/10periodic

    - name: UFW - Allow SSH connections
      ufw:
        rule: allow
        name: OpenSSH

    - name: UFW - Allow connections to postgreSQL (5432)
      ufw:
        rule: allow
        port: "5432"

    - name: UFW - Allow connections to postgreSQL (6543)
      ufw:
        rule: allow
        port: "6543"
      tags:
        - install-pgbouncer

    - name: UFW - Deny all other incoming traffic by default
      ufw:
        state: enabled
        policy: deny
        direction: incoming

    - name: Setup logrotate for postgres logs
      copy:
        src: files/logrotate-postgres
        dest: /etc/logrotate.d/postgres

    - name: Setup logrotate for postgres CSV logs
      copy:
        src: files/logrotate-postgres-csv
        dest: /etc/logrotate.d/postgres-csv

    - name: Disable cron access
      copy:
        src: files/cron.deny
        dest: /etc/cron.deny

    - name: Configure logrotation to run every hour
      shell:
        cmd: |
            cp  /usr/lib/systemd/system/logrotate.timer /etc/systemd/system/logrotate.timer
            sed -i -e 's;daily;*:0/10;' /etc/systemd/system/logrotate.timer
            systemctl reenable logrotate.timer
      become: yes

    - name: First boot optimizations
      import_tasks: tasks/internal/optimizations.yml
      tags:
        - install-supabase-internal

    - name: Enhance fail2ban
      import_tasks: tasks/setup-fail2ban.yml

    # Install EC2 instance connect
    # Only for AWS images
    - name: install EC2 instance connect
      become: yes
      apt:
        pkg:
          - ec2-instance-connect
      tags:
        - aws-only

    # Install this at the end to prevent it from kicking in during the apt process, causing conflicts
    - name: Install security tools
      become: yes
      apt:
        pkg:
          - unattended-upgrades
        update_cache: yes
        cache_valid_time: 3600

    # Put PG binaries in a directory under $PATH
    - name: Find all files in /usr/lib/postgresql/bin
      find:
        paths: /usr/lib/postgresql/bin
      register: postgresql_bin

    - name: Create symbolic links for Postgres binaries to /usr/bin/
      become: yes
      shell:
        cmd: "for fl in /usr/lib/postgresql/bin/* ; do ln -sf $fl /usr/bin/$(basename $fl) ; done"
