name: Nix CI

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  contents: write
  packages: write
  id-token: write    
    
jobs:
  unintall-nix:
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: [self-hosted, X64]
            arch: amd64
          - runner: arm-runner
            arch: arm64
    runs-on: ${{ matrix.runner }}

    steps:
      - run: sudo /nix/nix-installer uninstall
    name: uninstall-nix
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: [self-hosted, X64]
            arch: amd64
          - runner: arm-runner
            arch: arm64
        cmd: [ "nix flake check -L --show-trace", "nix build .#psql_15/bin .#psql_15/docker"]
    runs-on: ${{ matrix.runner }}
    name: nix-build
    steps:
      - uses: actions/checkout@c85c95e3d7251135ab7dc9ce3241c5835cc595a9
        with:
          fetch-depth: 0
      - uses: DeterminateSystems/nix-installer-action@v10
      #- uses: DeterminateSystems/magic-nix-cache-action@main 
      - run: ${{ matrix.cmd }}
    needs: unintall-nix
